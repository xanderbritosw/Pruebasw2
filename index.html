<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>XanFarm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #fefae0;
      height: 100%;
      width: 100vw;
      overscroll-behavior: contain;
    }
    #pantallaPrincipal {
      background-image: url("https://i.imgur.com/qbJMnhv.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      min-width: 100vw;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: red;
      padding: 20px 0 0 0;
      z-index: 1;
      position: relative;
      box-sizing: border-box;
    }
    .moneda-bar {
      margin: 0 0 10px 0;
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
    }
    .moneda-bar span {
      background: rgba(255,255,255,0.85);
      color: #33;
      border-radius: 16px;
      padding: 6px 14px;
      margin: 0 2px;
      font-weight: bold;
      display: inline-block;
      min-width: 70px;
    }
    .menu {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      background: #fff;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 10px 0;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 999;
    }
    .menu button {
      flex: 1 0 30%;
      margin: 6px 4px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background-color: #fff;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .menu button:active { transform: scale(0.97); }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 92%;
      max-width: 450px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .close-btn {
      align-self: flex-end;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .cofre-img {
      width: 140px;
      max-width: 80vw;
      margin: 24px auto 12px auto;
      display: block;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .cofre-img.abierto {
      animation: cofre-abierto 0.7s cubic-bezier(.21,1.02,.73,.97);
    }
    @keyframes cofre-abierto {
      0% { transform: scale(1) rotate(0deg);}
      30% { transform: scale(1.18) rotate(-8deg);}
      60% { transform: scale(1.1) rotate(6deg);}
      100% { transform: scale(1) rotate(0deg);}
    }
    .cofre-info {
      margin-bottom: 14px;
      color: #222;
      font-weight: bold;
    }
    .cofre-keys {
      font-size: 1rem;
      margin-top: 2px;
    }
    .cofre-open-btn {
      padding: 10px 26px;
      background-color: #3777ca;
      color: black;
      border: 0;
      border-radius: 8px;
      font-size: 1.1rem;
      margin-bottom: 12px;
      margin-top: 4px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .cofre-open-btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .tab-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
      gap: 6px;
    }
    .tab-selector button {
      margin: 4px 0;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #eee;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-selector .active {
      background: #3777ca;
      color: white;
    }
    #resultadoCofre { min-height: 24px; }

    .plant {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      background: #fafafa;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .plant img {
      width: 34px;
      border-radius: 5px;
    }
    .plant-info {
      flex: 1;
    }
    .production {
      color: #3777ca;
      font-size: 14px;
      font-weight: bold;
      margin-left: 8px;
    }
    #progresoProduccion {
      width: 270px;
      height: 22px;
      background: #eee;
      border-radius: 13px;
      margin: 10px auto 5px auto;
      position: relative;
      overflow: hidden;
      border: 1.5px solid #bdbdbd;
      box-shadow: 0 1px 5px #0001;
    }
    #barraProduccion {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      height: 100%;
      background: linear-gradient(90deg, #ffe066, #4dd599 90%);
      width: 0%;
      border-radius: 13px 0 0 13px;
      transition: width 0.7s cubic-bezier(.23,.89,.43,.99);
    }
    #contadorProduccion {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 1.07em;
      color: #13314e;
      text-shadow: 0 1px 5px #fff, 0 1px 6px #13314e22;
    }
    #btnRecolectar {
      margin: 10px auto 0 auto;
      padding: 12px 30px;
      font-size: 1.13em;
      background: #4dd599;
      color: #fff;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
      box-shadow: 0 2px 6px #4dd59944;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #btnRecolectar:disabled {
      background: #ddd;
      color: #aaa;
      cursor: not-allowed;
    }
    #granjeroAnim {
      width: 40px;
      height: 40px;
      margin-right: 5px;
      border-radius: 50%;
      object-fit: cover;
      background: #eee;
      animation: correr 1.2s infinite linear;
      display: inline-block;
    }
    @keyframes correr {
      0% { transform: translateX(0);}
      25% { transform: translateX(15px);}
      50% { transform: translateX(0);}
      75% { transform: translateX(-15px);}
      100% { transform: translateX(0);}
    }
    #recoleccionAnimada {
      font-size: 2.2em;
      color: #ffe066;
      position: absolute;
      left: 50%;
      top: 15%;
      transform: translate(-50%,0);
      z-index: 1001;
      pointer-events: none;
      animation: monedasSalto 1.2s cubic-bezier(.21,1.02,.73,.97);
      display: none;
      background: rgba(255,255,255,0.82);
      border-radius: 18px;
      padding: 18px 36px;
      box-shadow: 0 2px 16px #ffe06677;
    }
    @keyframes monedasSalto {
      0% { opacity:0; transform: translate(-50%,30px) scale(0.7);}
      20% { opacity:1; transform: translate(-50%,-16px) scale(1.07);}
      60% { opacity:1; transform: translate(-50%,-28px) scale(1.07);}
      100% { opacity:0; transform: translate(-50%,0) scale(0.7);}
    }
    .moneda-icon {
      width: 20px;
      vertical-align: middle;
      margin-right: 3px;
    }
    .proximamente {
      color: #888;
      font-style: italic;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      margin: 15px 0;
    }
    .mission {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      text-align: left;
    }
    .mission small {
      display: block;
      margin-top: 4px;
      color: #666;
    }
    .btn-reclamar {
      background: #4dd599;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      margin-top: 8px;
      cursor: pointer;
    }
    .perfil-fondo {
      background: url('https://i.imgur.com/n9OyA2U.png') center/cover no-repeat, #15151a;
      box-shadow: 0 0 25px #00ffe788;
      color: #fff !important;
      border: 2.5px solid #00ffe7;
      position: relative;
    }
    .perfil-avatar {
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
    }
    .gamer-rango {
      background: linear-gradient(90deg, #00ffe7 10%, #0ff 40%, #aaf 60%, #00ffe7 90%);
      color: #fff;
      padding: 3px 18px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: 1px;
      font-size: 1.13em;
      filter: drop-shadow(0 0 5px #00ffe7) drop-shadow(0 0 8px #fff);
      text-shadow: 0 0 7px #00ffe7, 0 0 15px #fff;
      border: 2px solid #00ffe7;
      margin-left: 4px;
      box-shadow: 0 0 18px #00ffe788;
    }
    .cofre-fondo-plata {
      background: url('https://i.imgur.com/9DvPrS8.png') center/cover no-repeat, #f7f7f7 !important;
    }
    .cofre-fondo-oro {
      background: url('https://i.imgur.com/MVPWQeH.png') center/cover no-repeat, #fff8e1 !important;
    }
    .cofre-fondo-diamante {
      background: url('https://i.imgur.com/WD9fqx0.png') center/cover no-repeat, #e0f7fa !important;
    }
    #inventoryModal .modal-content {
      background: url('https://i.imgur.com/WyHOTjm.png') center/cover no-repeat, #fff !important;
    }
    .canjear-codigo-box {
      margin: 18px 0 0 0;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .canjear-codigo-box input {
      padding: 7px 11px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 15px;
    }
    .canjear-codigo-box button {
      background: #46b1e5;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 7px 19px;
      cursor: pointer;
      font-weight: bold;
    }
    .canjear-codigo-box button:hover {
      background: #3689b0;
    }
    :root {
  --color-principal: #3777ca;
  --color-secundario: #f8f8fa;
  --color-acento: #ffd700;
  --color-btn: #43b581;
  --color-btn-retirar: #f7b731;
  --color-fondo-modal: rgba(40,40,70,0.95);
  --color-txt: #222;
}

/* Botones de menú */
.menu-btn {
  background: var(--color-principal);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 12px 20px;
  margin: 5px 0;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 8px #0002;
  transition: background 0.2s;
}
.menu-btn:hover {
  background: #28599a;
}

/* Modal base */
.modal {
  display: none;
  position: fixed; z-index: 999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: var(--color-fondo-modal);
  align-items: center; justify-content: center;
}
.modal-content {
  background: var(--color-secundario);
  border-radius: 16px;
  box-shadow: 0 8px 32px #0005;
  padding: 32px 24px;
  min-width: 320px; max-width: 90vw;
  position: relative;
  color: var(--color-txt);
}

.close-btn {
  position: absolute; top: 16px; right: 24px;
  cursor: pointer; font-size: 1.5em;
  color: #888;
}
.close-btn:hover { color: #f44; }

/* Balance */
#balanceModal .modal-content {
  border-left: 7px solid var(--color-principal);
  text-align: left;
}
.balance-list {
  margin: 15px 0 10px 0;
  padding: 0;
}
.balance-list li {
  list-style: none;
  margin: 10px 0;
  font-size: 1.2em;
  font-weight: 500;
}
.balance-moneda { color: var(--color-principal); }
.balance-gf { color: var(--color-btn-retirar); }
.balance-llaves { color: var(--color-btn); }

/* Modal Retiros */
#retirosModal .modal-content {
  border-left: 7px solid var(--color-btn-retirar);
}
#retiroMensaje {
  margin-top: 12px;
  font-weight: 600;
  color: var(--color-btn);
  min-height: 22px;
}

#convertirAGFBtn {
  background: var(--color-btn);
  color: #fff;
}
#convertirAGFBtn:hover { background: #2e9d5b; }

#pedirRetiroBtn {
  background: var(--color-btn-retirar);
  color: #222;
}
#pedirRetiroBtn:hover { background: #e1a61f; }

.historial-table {
  width: 100%; margin-top: 16px; border-collapse: collapse;
  font-size: 0.97em;
}
.historial-table th, .historial-table td {
  padding: 7px 6px; text-align: center;
  border-bottom: 1px solid #e2e2e2;
}
.historial-table th {
  background: #f7f7f7;
  color: #444;
  font-weight: 600;
}
.historial-table .pendiente { color: #f39c12; font-weight: 700; }
.historial-table .pagado { color: #43b581; font-weight: 700; }

@media (max-width: 540px) {
  .modal-content { min-width: 95vw; padding: 18px 5vw; }
  .historial-table th, .historial-table td { font-size: 0.9em; }
}
    /* ==== NUEVOS COLORES PARA XANFARM ==== */

/* 1. Botones menú inferior: Balance y Retiros */
.menu-btn,
#retirosBtn,
#convertirAGFBtn,
#pedirRetiroBtn {
  background: linear-gradient(90deg, #7ec850 60%, #4a7e2d 100%);
  color: #fff !important;
  border: none;
  font-weight: bold;
  box-shadow: 0 2px 10px #4a7e2d44;
  transition: background 0.17s, color 0.17s;
}
.menu-btn:hover,
#retirosBtn:hover,
#convertirAGFBtn:hover,
#pedirRetiroBtn:hover {
  background: linear-gradient(90deg, #62a337 60%, #275325 100%);
  color: #ffd700 !important;
}

/* 2. Títulos principales */
#pantallaPrincipal h1,
.modal-content h2,
.perfil-fondo h2 {
  color: #42652d !important;
  text-shadow: 0 2px 10px #fff8, 0 1px 0 #adc27e;
  letter-spacing: 1px;
  font-weight: 900;
}

/* 3. Pantalla de inicio: mejora contraste y legibilidad */
#pantallaPrincipal,
#pantallaPrincipal span,
#pantallaPrincipal > div,
#contadorProduccion {
  color: #2d3122 !important;
  text-shadow: 0 1px 5px #fff8;
}

/* 4. Modal de perfil: fondo oscuro, texto claro */
.perfil-fondo {
  background: linear-gradient(135deg, #6dbd7a 65%, #eaf6e2 100%) !important;
  color: #183b13 !important;
  border: 2.5px solid #3777ca;
  box-shadow: 0 0 25px #3777ca55;
}
.perfil-fondo .perfil-avatar img {
  border: 3px solid #fffda2 !important;
  box-shadow: 0 0 14px #adc27e88 !important;
}
.gamer-rango {
  background: linear-gradient(90deg, #e6e24c 10%, #7ec850 60%, #e6e24c 90%);
  color: #2d3122 !important;
  border: 2px solid #7ec850 !important;
  text-shadow: 0 1px 6px #fff9, 0 0 7px #adc27e66;
}

/* 5. Extra: resalta btn recolectar */
#btnRecolectar {
  background: linear-gradient(90deg, #f6be3e 60%, #c2a43e 100%);
  color: #fff;
  border: none;
  font-weight: bold;
  box-shadow: 0 2px 10px #c2a43e44;
}
#btnRecolectar:hover {
  background: linear-gradient(90deg, #d19d21 60%, #847200 100%);
  color: #fffbe7;
}

/* 6. Extra: mejora titulos secundarios */
.modal-content h3,
.modal-content strong {
  color: #3777ca !important;
}

/* 7. Si algún botón secundario queda blanco, fuerza color campestre */
.menu button:not(.menu-btn) {
  background: #eaf6e2;
  color: #42652d;
  border: 1.5px solid #c2e7b0;
}
.menu button:not(.menu-btn):hover {
  background: #c2e7b0;
  color: #183b13;
}

/* ==== FIN NUEVOS COLORES ==== */
  </style>
</head>
<body>
  <!-- Modal Balance -->
<div id="balanceModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="cerrarBalanceBtn">×</span>
    <h2>💰 Tu Balance</h2>
    <ul class="balance-list">
      <li>Monedas normales: <span class="balance-moneda" id="balMonedas">0</span></li>
      <li>Monedas GF: <span class="balance-gf" id="balGF">0</span></li>
      <li>Llaves: <span class="balance-llaves" id="balKeys">0</span></li>
    </ul>
  </div>
</div>

<!-- Modal Retiros -->
<div id="retirosModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="cerrarRetirosBtn">×</span>
    <h2>🏦 Sistema de Retiros</h2>
    <div>
      <strong>Monedas normales:</strong> <span id="retiroMonedas">0</span><br>
      <strong>Monedas GF:</strong> <span id="retiroGF">0</span>
    </div>
    <div style="margin-top:14px;">
      <button id="convertirAGFBtn">Convertir 100 monedas → 1 GF</button>
    </div>
    <div style="margin-top:14px;">
      <button id="pedirRetiroBtn">Solicitar retiro (mín. 100 GF)</button>
    </div>
    <div id="retiroMensaje"></div>
    <h3 style="margin-top:23px;">Historial de retiros</h3>
    <table class="historial-table" id="tablaHistorialRetiros">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cantidad GF</th>
          <th>Fecha</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llena dinámicamente -->
      </tbody>
    </table>
  </div>
</div>
  <div id="recoleccionAnimada"></div>
  <div id="pantallaPrincipal">
    <h1> ¡Bienvenido a XanFarm!♡</h1>
    <div class="moneda-bar">
      <span>
        <img src="https://i.imgur.com/n9OyA2U.png" class="moneda-icon" alt="Moneda">
        Monedas: <span id="coins">0</span>
      </span>
      <span>🔑 Llaves: <span id="keys">0</span></span>
    </div>
    <div id="progresoProduccion">
      <div id="barraProduccion"></div>
    </div>
    <div id="contadorProduccion"><b>Producción lista en:</b> <span id="timerProduccion">--:--:--</span></div>
    <button id="btnRecolectar" disabled>
      <img id="granjeroAnim" src="https://i.imgur.com/eTvi8JP.jpeg" alt="Granjero pixelado" style="background:#eee;">
      Recolectar producción
    </button>
  </div>

  <div class="menu">
    <button id="botonPerfil">🧑‍💻 Perfil</button>
    <button id="botonInventario">🎒 Inventario</button>
    <button id="botonCofre">🎁 Cofre</button>
    <button id="botonMisiones">🧭 Misiones</button>
    <button id="botonTienda">🏪 Tienda</button>
    <button id="botonOpciones">⚙️ Opciones</button>
    <div id="menu-acciones">
  <!-- Otros botones -->
  <button id="botonBalance" class="menu-btn">💰 Balance</button>
  <button id="retirosBtn" class="menu-btn">🏦 Retiros</button>
</div>
  </div>

  <!-- Cofres Modal -->
  <div id="cofreModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarCofreBtn">×</span>
      <h2 id="tituloCofre">🎁 Cofre Plata</h2>
      <div class="tab-selector">
        <button id="tabPlata" class="active">Plata</button>
        <button id="tabOro">Oro</button>
        <button id="tabDiamante">Diamante</button>
      </div>
      <img id="imgCofre" class="cofre-img" src="https://i.imgur.com/dYd1aoN.png" alt="Cofre" />
      <div class="cofre-info" id="cofreInfo">
        Necesitas <span id="llavesNecesarias">10</span> llaves para abrir este cofre.<br>
        <span class="cofre-keys">Tienes: <span id="userKeys">0</span> llaves</span>
      </div>
      <button id="abrirCofreBtn" class="cofre-open-btn">Abrir Cofre de Plata</button>
      <div id="resultadoCofre"></div>
      <button id="cerrarCofreBtn2">Cerrar</button>
    </div>
  </div>

  <!-- Perfil Modal Mejorado -->
  <div id="profileModal" class="modal">
    <div class="modal-content perfil-fondo">
      <span class="close-btn" id="cerrarPerfilBtn">×</span>
      <h2 style="margin-bottom:8px;">🧑‍🌾 Tu Perfil</h2>
      <div class="perfil-avatar">
        <img src="https://i.imgur.com/n9OyA2U.png" alt="Avatar" style="width:90px; border-radius:200%; border:3px solid #00ffe7;box-shadow:0 0 18px #00ffe799;">
      </div>
      <div style="margin:12px 0 8px 0;">
        <strong>Rango:</strong>
        <span id="perfilRango" class="gamer-rango"></span>
      </div>
      <div>
        <strong>Producción diaria:</strong> <span id="perfilProduccion"></span> monedas/día
      </div>
      <div>
        <strong>Monedas:</strong> <span id="perfilCoins">0</span>
      </div>
      <div>
        <strong>Llaves:</strong> <span id="perfilKeys">0</span>
      </div>
    </div>
  </div>

  <!-- Inventario Modal -->
  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarInventarioBtn">×</span>
      <h2>🎒 Inventario de Cultivos</h2>
      <div id="plantList"></div>
    </div>
  </div>

  <!-- Misiones Modal -->
  <div id="missionsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarMisionesBtn">×</span>
      <h2>🧭 Misiones</h2>
      <div class="tab-selector">
        <button id="tabDiarias" class="active">🔄 Diarias</button>
        <button id="tabSemanales">📅 Semanales</button>
        <button id="tabDesafio">💥 Desafíos</button>
      </div>
      <div id="misionesContenedor"></div>
    </div>
  </div>

  <!-- Tienda Modal NUEVA -->
  <div id="newShopModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarTiendaNuevaBtn">×</span>
      <h2>🏪 Tienda</h2>
      <div id="paquetesTienda"></div>
      <!-- CAMPO DE CANJE DE CÓDIGO -->
      <div class="canjear-codigo-box">
        <input id="codigoInput" type="text" placeholder="Ingresa tu código de paquete">
        <button onclick="canjearCodigo()">Canjear</button>
      </div>
      <hr>
      <div>
        <b>Conversión:</b> 100 monedas = 10 llaves
        <button id="convertirMonedasBtn" style="margin-left:10px;">Convertir</button>
      </div>
      <div style="margin:12px 0 0 0;">
        <button id="retirosBtn" style="background:#ffd600;color:#222;border:none;border-radius:7px;padding:9px 20px;">Retiros</button>
      </div>
    </div>
  </div>

  <!-- MODAL OPCIONES -->
  <div id="optionsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarOpcionesBtn">×</span>
      <h2>⚙️ Opciones</h2>
      <button id="borrarProgresoBtn" style="background:#f44;color:#fff;margin:8px 0;border:none;border-radius:7px;padding:10px 16px;font-size:1em;">Borrar Progreso</button>
      <button id="ajustarBrilloBtn" style="margin:8px 0;">Ajustar Brillo</button>
      <button id="musicaBtn" style="margin:8px 0;">Desactivar Música</button>
      <button id="billeteraBtn" style="margin:8px 0;">Conectar Billetera</button>
      <div style="margin-top:16px;">
        <a href="#" id="politicasLink" style="color:#3777ca;text-decoration:underline;">Políticas de Privacidad</a>
      </div>
    </div>
  </div>

  <!-- MODAL POLÍTICAS -->
  <div id="politicasModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarPoliticasBtn">×</span>
      <h2>Políticas de Privacidad</h2>
      <div style="text-align:left;">
        XanFarm respeta tu privacidad. No compartimos tus datos personales con terceros. Los datos de juego se guardan solo localmente y puedes eliminarlos desde Opciones.
      </div>
    </div>
  </div>

  <!-- MODAL RETIROS -->
  <div id="retirosModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="cerrarRetirosBtn">×</span>
      <h2>Retiros</h2>
      <div>Contacta al Soporte en el Bot Pay.</div>
    </div>
  </div>
  <script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // --- Configuración Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDoEwGkNnjJY6kIvISs1zgiDgU3MCrkZno",
      authDomain: "xanfarm-web.firebaseapp.com",
      databaseURL: "https://xanfarm-web-default-rtdb.firebaseio.com",
      projectId: "xanfarm-web",
      storageBucket: "xanfarm-web.appspot.com",
      messagingSenderId: "703765140128",
      appId: "1:703765140128:web:58f1816df69936bc28efc5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Obtener Telegram ID de la URL ---
    function getTelegramId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('telegram_id') || 'noid';
    }
    const telegramId = getTelegramId();

    // ---------- DATOS POR DEFECTO ----------
    const PLANTS_DEFAULT = [
      { nombre: "Piña dorada", valor: 500, cantidad: 0, rareza: "Legendaria", img: "https://i.imgur.com/4LLQVZR.png" },
      { nombre: "Uva eléctrica", valor: 350, cantidad: 0, rareza: "Legendaria", img: "https://i.imgur.com/3kY9HG7.png" },
      { nombre: "Cereza de lava", valor: 350, cantidad: 0, rareza: "Legendaria", img: "https://i.imgur.com/nlhsGu0.png" },
      { nombre: "Flor de cacao", valor: 180, cantidad: 0, rareza: "Épica", img: "https://i.imgur.com/DmtOhmA.png" },
      { nombre: "Melón ámbar", valor: 180, cantidad: 0, rareza: "Épica", img: "https://i.imgur.com/ZwC4Kde.png" },
      { nombre: "Frijol lunar", valor: 70, cantidad: 0, rareza: "Rara", img: "https://i.imgur.com/DHMhAut.png" },
      { nombre: "Zanahoria cristal", valor: 70, cantidad: 0, rareza: "Rara", img: "https://i.imgur.com/PqYvGOs.png" },
      { nombre: "Choclo místico", valor: 70, cantidad: 0, rareza: "Rara", img: "https://i.imgur.com/tlQeAup.png" },
      { nombre: "Maíz dulce", valor: 30, cantidad: 0, rareza: "Común", img: "https://i.imgur.com/o6yWfY0.png" },
      { nombre: "Tomate solar", valor: 30, cantidad: 0, rareza: "Común", img: "https://i.imgur.com/QdRLusf.png" },
      { nombre: "Trigo solar", valor: 30, cantidad: 0, rareza: "Común", img: "https://i.imgur.com/8U8tirk.png" }
    ];

    // ---------- VARIABLES GLOBALES ----------
    let coins = 0;
    let keys = 0;
    let plants = [];
    let cofresGratis = { oro: 0, plata: 0 };
    let lastRecolectado = Date.now();
    let monedasGF = 0;
    let historialRetiros = [];

    // ---------- FUNCIONES FIREBASE ----------
    function guardarProgresoFirebase() {
      db.ref('jugadores/' + telegramId).set({
        coins, keys, plants, cofresGratis, lastRecolectado, monedasGF
      });
      db.ref('retiros/' + telegramId).set(historialRetiros);
    }
    function cargarProgresoFirebase(callback) {
      db.ref('jugadores/' + telegramId).once('value', snap => {
        if (snap.exists()) {
          const obj = snap.val();
          coins = obj.coins || 0;
          keys = obj.keys || 0;
          plants = obj.plants || JSON.parse(JSON.stringify(PLANTS_DEFAULT));
          cofresGratis = obj.cofresGratis || { oro: 0, plata: 0 };
          lastRecolectado = obj.lastRecolectado || Date.now();
          monedasGF = obj.monedasGF || 0;
        } else {
          coins = 0; keys = 0; plants = JSON.parse(JSON.stringify(PLANTS_DEFAULT));
          cofresGratis = { oro: 1, plata: 3 }; lastRecolectado = Date.now(); monedasGF = 0;
          guardarProgresoFirebase();
        }
        // Retiros
        db.ref('retiros/' + telegramId).once('value', snap2 => {
          historialRetiros = snap2.val() || [];
          if (callback) callback();
        });
      });
    }

    // ---------- CARGA AUTOMÁTICA ----------
    window.addEventListener("load", () => {
      cargarProgresoFirebase(() => {
        actualizarMonedas();
        renderizarHistorialRetiros();
      });
    });

    // ---------- GUARDADO AUTOMÁTICO ----------
    setInterval(guardarProgresoFirebase, 30000);

    // ---------- BALANCE MODAL ----------
    document.getElementById("botonBalance").onclick = () => {
      document.getElementById("balMonedas").innerText = coins;
      document.getElementById("balGF").innerText = monedasGF;
      document.getElementById("balKeys").innerText = keys;
      document.getElementById("balanceModal").style.display = "flex";
    };
    document.getElementById("cerrarBalanceBtn").onclick = () =>
      document.getElementById("balanceModal").style.display = "none";

    // ---------- RETIROS MODAL ----------
    document.getElementById("retirosBtn").onclick = () => {
      document.getElementById("retiroMonedas").innerText = coins;
      document.getElementById("retiroGF").innerText = monedasGF;
      document.getElementById("retiroMensaje").innerText = "";
      renderizarHistorialRetiros();
      document.getElementById("retirosModal").style.display = "flex";
    };
    document.getElementById("cerrarRetirosBtn").onclick = () =>
      document.getElementById("retirosModal").style.display = "none";

    // ---------- CONVERSIÓN MONEDAS → GF ----------
    document.getElementById("convertirAGFBtn").onclick = () => {
      if (coins < 100) {
        document.getElementById("retiroMensaje").innerText =
          "No tienes suficientes monedas normales para convertir.";
        return;
      }
      coins -= 100;
      monedasGF += 1;
      guardarProgresoFirebase();
      document.getElementById("retiroMonedas").innerText = coins;
      document.getElementById("retiroGF").innerText = monedasGF;
      actualizarMonedas();
      document.getElementById("retiroMensaje").innerText = "¡Conversión exitosa!";
    };

    // ---------- SOLICITAR RETIRO ----------
    document.getElementById("pedirRetiroBtn").onclick = () => {
      if (monedasGF < 100) {
        document.getElementById("retiroMensaje").innerText =
          "El mínimo de retiro es 100 GF.";
        return;
      }
      monedasGF -= 100;
      const retiro = registrarRetiro(100);
      guardarProgresoFirebase();
      document.getElementById("retiroGF").innerText = monedasGF;
      renderizarHistorialRetiros();
      document.getElementById("retiroMensaje").innerText =
        `¡Solicitud enviada! Tu ID de retiro es ${retiro.id}.`;
    };

    // ---------- REGISTRAR RETIRO ----------
    function registrarRetiro(gfCantidad) {
      const id =
        "RET-" +
        Date.now().toString(36) +
        "-" +
        Math.floor(Math.random() * 10000).toString(36);
      const retiro = {
        id,
        gf: gfCantidad,
        fecha: new Date().toLocaleString(),
        estado: "pendiente",
      };
      historialRetiros.push(retiro);
      db.ref('retiros/' + telegramId).set(historialRetiros);
      return retiro;
    }

    // ---------- HISTORIAL DE RETIROS ----------
    function renderizarHistorialRetiros() {
      const tbody = document.getElementById("tablaHistorialRetiros").querySelector("tbody");
      tbody.innerHTML = "";
      if (!historialRetiros.length) {
        tbody.innerHTML =
          "<tr><td colspan='4' style='color:#999'>Sin retiros realizados</td></tr>";
      } else {
        historialRetiros
          .slice()
          .reverse()
          .forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.id}</td>
              <td>${r.gf}</td>
              <td>${r.fecha}</td>
              <td class="${r.estado}">${r.estado.charAt(0).toUpperCase() + r.estado.slice(1)}</td>
            `;
            tbody.appendChild(tr);
          });
      }
    }
  // ----- LÓGICA DE COFRES -----
  function abrirCofre(tipo) {
    // ... lógica de apertura de cofres ...
    // Cuando el usuario gana premio:
    coins += premioMonedas;
    keys += premioLlaves;
    guardarProgresoFirebase();
    actualizarMonedas();
    // ...
  }

  // ----- LÓGICA DE PLANTAS -----
  function comprarPlanta(idx) {
    let planta = plants[idx];
    if (coins < planta.valor) return;
    coins -= planta.valor;
    planta.cantidad += 1;
    guardarProgresoFirebase();
    actualizarMonedas();
    // ...
  }

  // ----- CANJEAR CÓDIGOS -----
  document.getElementById("canjearCodigoBtn").onclick = () => {
    let codigo = document.getElementById("inputCodigo").value.trim();
    if (!codigo) return;
    db.ref("codigos").child(codigo).once("value", snap => {
      if (!snap.exists()) {
        mostrarMensajeCodigo("Código no válido.");
        return;
      }
      let info = snap.val();
      if (info.usado) {
        mostrarMensajeCodigo("Este código ya fue canjeado.");
        return;
      }
      // Marcar como usado
      db.ref("codigos").child(codigo).set({
        ...info,
        usado: true,
        telegramId: telegramId,
        fecha: new Date().toISOString()
      });
      // Otorgar premio
      coins += info.monedas || 0;
      keys += info.llaves || 0;
      guardarProgresoFirebase();
      mostrarMensajeCodigo("¡Código canjeado correctamente!");
    });
  };

  function mostrarMensajeCodigo(msj) {
    document.getElementById("mensajeCodigo").innerText = msj;
  }

  // ----- ACTUALIZAR MONEDAS -----
  function actualizarMonedas() {
    document.getElementById("monedasSpan").innerText = coins;
    document.getElementById("llavesSpan").innerText = keys;
    // ----- TIENDA -----
function mostrarTienda() {
  const lista = document.getElementById("listaTienda");
  lista.innerHTML = "";
  plants.forEach((planta, idx) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <img src="${planta.img}" width="32" height="32">
      <span>${planta.nombre} (${planta.rareza})</span>
      <span>Valor: ${planta.valor} monedas</span>
      <span>Cantidad: ${planta.cantidad}</span>
      <button onclick="comprarPlanta(${idx})">Comprar</button>
    `;
    lista.appendChild(li);
  });
  document.getElementById("tiendaModal").style.display = "flex";
}
document.getElementById("abrirTiendaBtn").onclick = mostrarTienda;
document.getElementById("cerrarTiendaBtn").onclick = () => {
  document.getElementById("tiendaModal").style.display = "none";
};

function comprarPlanta(idx) {
  const planta = plants[idx];
  if (coins < planta.valor) {
    alert("No tienes suficientes monedas.");
    return;
  }
  coins -= planta.valor;
  planta.cantidad += 1;
  guardarProgresoFirebase();
  actualizarMonedas();
  mostrarTienda();
}

// ----- LÓGICA DE PREMIO DIARIO -----
function otorgarPremioDiario() {
  const ahora = Date.now();
  // Permitir premio diario cada 24 horas
  if (ahora - lastRecolectado < 24 * 60 * 60 * 1000) {
    alert("Ya reclamaste el premio diario. Espera hasta mañana.");
    return;
  }
  const premio = Math.floor(Math.random() * 50) + 50; // 50-99 monedas
  coins += premio;
  lastRecolectado = ahora;
  guardarProgresoFirebase();
  actualizarMonedas();
  alert(`¡Has recibido tu premio diario de ${premio} monedas!`);
}
document.getElementById("premioDiarioBtn").onclick = otorgarPremioDiario;

// ----- LÓGICA DE COFRE GRATIS -----
function abrirCofreGratis(tipo) {
  if (tipo === "oro" && cofresGratis.oro > 0) {
    cofresGratis.oro -= 1;
    coins += 500;
    keys += 5;
    guardarProgresoFirebase();
    actualizarMonedas();
    alert("¡Cofre de oro abierto! +500 monedas y +5 llaves.");
  } else if (tipo === "plata" && cofresGratis.plata > 0) {
    cofresGratis.plata -= 1;
    coins += 200;
    keys += 2;
    guardarProgresoFirebase();
    actualizarMonedas();
    alert("¡Cofre de plata abierto! +200 monedas y +2 llaves.");
  } else {
    alert("No tienes cofres gratis de ese tipo.");
  }
}

// ----- RESTO DE FUNCIONES DEL JUEGO -----

// Ejemplo de selector de cofres en pantalla principal
document.getElementById("abrirCofreOroBtn").onclick = () => abrirCofreGratis("oro");
document.getElementById("abrirCofrePlataBtn").onclick = () => abrirCofreGratis("plata");

// Plantar y cosechar plantas (ejemplo)
function plantar(idx) {
  if (plants[idx].cantidad < 1) {
    alert("No tienes esa planta para sembrar.");
    return;
  }
  // Simula cosecha instantánea
  const recompensa = Math.floor(plants[idx].valor * 0.5);
  coins += recompensa;
  plants[idx].cantidad -= 1;
  guardarProgresoFirebase();
  actualizarMonedas();
  alert(`¡Cosechaste ${plants[idx].nombre} y ganaste ${recompensa} monedas!`);
}

// Asocia botones de plantar (si tienes en tu HTML)
plants.forEach((_, idx) => {
  const btn = document.getElementById(`plantarBtn${idx}`);
  if (btn) btn.onclick = () => plantar(idx);
});

// ----- GENERALES -----
function cerrarModales() {
  document.querySelectorAll(".modal").forEach(m => m.style.display = "none");
}
document.querySelectorAll(".cerrarBtn").forEach(btn => btn.onclick = cerrarModales);

  </script>
</body>
</html>